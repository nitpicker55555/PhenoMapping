{% extends "base.html" %}

{% block title %}Species Research - Plant Phenology Observation Data Visualization Platform{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>
            <i class="fas fa-leaf text-success"></i>
            Plant Species Research
        </h2>
        <p class="text-muted">Explore the phenological characteristics and distribution of 97 plant species</p>
    </div>
</div>

<!-- Species Browse and Filter -->
<div class="row mb-4">
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-search me-2"></i>
                    Species Browser
                </h5>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="view-type" id="grid-view" checked>
                    <label class="btn btn-outline-secondary btn-sm" for="grid-view">
                        <i class="fas fa-th"></i>
                    </label>
                    
                    <input type="radio" class="btn-check" name="view-type" id="list-view">
                    <label class="btn btn-outline-secondary btn-sm" for="list-view">
                        <i class="fas fa-list"></i>
                    </label>
                </div>
            </div>
            <div class="card-body">
                <!-- Search Filters -->
                <div class="row mb-2">
                    <div class="col-12">
                        <small class="text-muted">Filter species by name, group, or phenological phase:</small>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="species-search" placeholder="Search species name...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="group-filter">
                            <option value="">All Groups</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="phase-filter" style="background-color: #f0f8f0;">
                            <option value="">All Phases</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="sort-by">
                            <option value="observation_count">By Observations</option>
                            <option value="name">By Name</option>
                        </select>
                    </div>
                </div>
                
                <!-- Grid View -->
                <div id="species-grid" class="row g-3">
                    <div class="col-12 text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                
                <!-- List View -->
                <div id="species-list" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Species</th>
                                    <th>German Name</th>
                                    <th>Latin Name</th>
                                    <th>Group</th>
                                    <th>Observation Count</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="species-table-body">
                                <!-- Data will be populated via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-4">
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Species Group Statistics
                </h6>
            </div>
            <div class="card-body">
                <canvas id="species-groups-chart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Species Information
                </h6>
            </div>
            <div class="card-body" id="species-info">
                <p class="text-muted text-center">Click on a species card to view detailed information</p>
            </div>
        </div>
    </div>
</div>

<!-- Species Detailed Analysis Modal -->
<div class="modal fade" id="speciesModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-species-title">
                    <i class="fas fa-leaf me-2"></i>
                    Species Detailed Analysis
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Phenophase Time Distribution</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="modal-phenology-chart"></canvas>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Observation Station Distribution</h6>
                            </div>
                            <div class="card-body p-0">
                                <div id="modal-species-map" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Basic Information</h6>
                            </div>
                            <div class="card-body" id="modal-species-info">
                                <!-- Basic Information -->
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Phenophase List</h6>
                            </div>
                            <div class="card-body" id="modal-phases-list">
                                <!-- Phenophase List -->
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Observation Statistics</h6>
                            </div>
                            <div class="card-body" id="modal-species-stats">
                                <!-- Observation Statistics -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" id="view-species-timeline">
                    <i class="fas fa-chart-line me-1"></i>View Time Trends
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allSpecies = [];
let currentSpecies = [];
let selectedSpecies = null;
let modalMap = null;

$(document).ready(function() {
    loadSpeciesData();
    loadPhasesData();
    
    // 事件绑定
    $('#species-search').on('input', filterSpecies);
    $('#group-filter').change(filterSpecies);
    $('#phase-filter').change(filterSpeciesByPhase);
    $('#sort-by').change(sortSpecies);
    $('input[name="view-type"]').change(toggleView);
    $('#view-species-timeline').click(viewSpeciesTimeline);
});

function loadSpeciesData() {
    $.get('/api/species')
        .done(function(species) {
            allSpecies = species;
            currentSpecies = species;
            
            // 填充分组筛选器
            const groups = [...new Set(species.map(s => s.group_name).filter(g => g))];
            groups.sort();
            groups.forEach(group => {
                $('#group-filter').append(`<option value="${group}">${group}</option>`);
            });
            
            displaySpecies(species);
            createGroupsChart(species);
        })
        .fail(function() {
            alert('Failed to load species');
        });
}

function displaySpecies(species) {
    displayGrid(species);
    displayList(species);
}

function displayGrid(species) {
    const grid = $('#species-grid');
    grid.empty();
    
    if (species.length === 0) {
        grid.html('<div class="col-12 text-center text-muted">No species found matching the criteria</div>');
        return;
    }
    
    species.forEach(sp => {
        const observationCount = parseInt(sp.observation_count) || 0;
        
        grid.append(`
            <div class="col-md-4 col-sm-6 mb-3">
                <div class="card species-card h-100" data-species-id="${sp.id}" style="cursor: pointer;">
                    <div class="card-body">
                        <h6 class="card-title text-success">${sp.species_name_en}</h6>
                        <p class="card-text">
                            <small class="text-muted">
                                <strong>German:</strong> ${sp.species_name_de}<br>
                                <strong>Latin Name:</strong> <em>${sp.species_name_la}</em>
                            </small>
                        </p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                ${sp.group_name ? `<span class="badge bg-light text-dark">${sp.group_name}</span>` : ''}
                            </small>
                            <span class="badge bg-primary">${observationCount.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            </div>
        `);
    });
    
    // 添加点击事件
    $('.species-card').click(function() {
        const speciesId = $(this).data('species-id');
        const species = allSpecies.find(s => s.id == speciesId);
        showSpeciesDetail(species);
    });
}

function displayList(species) {
    const tbody = $('#species-table-body');
    tbody.empty();
    
    if (species.length === 0) {
        tbody.html('<tr><td colspan="6" class="text-center text-muted">No species found matching the criteria</td></tr>');
        return;
    }
    
    species.forEach(sp => {
        const observationCount = parseInt(sp.observation_count) || 0;
        
        tbody.append(`
            <tr style="cursor: pointer;" data-species-id="${sp.id}">
                <td><strong class="text-success">${sp.species_name_en}</strong></td>
                <td>${sp.species_name_de}</td>
                <td><em>${sp.species_name_la}</em></td>
                <td>
                    ${sp.group_name ? `<span class="badge bg-light text-dark">${sp.group_name}</span>` : '-'}
                </td>
                <td>${observationCount.toLocaleString()}</td>
                <td>
                    <button class="btn btn-outline-primary btn-sm species-detail-btn" data-species-id="${sp.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `);
    });
    
    // 添加点击事件
    $('#species-table-body tr').click(function() {
        const speciesId = $(this).data('species-id');
        const species = allSpecies.find(s => s.id == speciesId);
        showSpeciesDetail(species);
    });
}

function createGroupsChart(species) {
    const groupCounts = {};
    species.forEach(sp => {
        const group = sp.group_name || 'Ungrouped';
        groupCounts[group] = (groupCounts[group] || 0) + 1;
    });
    
    const ctx = document.getElementById('species-groups-chart').getContext('2d');
    if (window.groupsChart) {
        window.groupsChart.destroy();
    }
    
    window.groupsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(groupCounts),
            datasets: [{
                data: Object.values(groupCounts),
                backgroundColor: [
                    '#2c5234', '#52b788', '#95d5b2', '#b7e4c7', 
                    '#d8f3dc', '#74c69d', '#40916c', '#081c15'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12,
                        font: {
                            size: 10
                        }
                    }
                }
            }
        }
    });
}

function filterSpecies() {
    const searchTerm = $('#species-search').val().toLowerCase();
    const groupFilter = $('#group-filter').val();
    
    let filtered = allSpecies.filter(sp => {
        const matchesSearch = !searchTerm || 
            sp.species_name_en.toLowerCase().includes(searchTerm) ||
            sp.species_name_de.toLowerCase().includes(searchTerm) ||
            sp.species_name_la.toLowerCase().includes(searchTerm);
            
        const matchesGroup = !groupFilter || sp.group_name === groupFilter;
        
        return matchesSearch && matchesGroup;
    });
    
    currentSpecies = filtered;
    sortSpecies();
}

function sortSpecies() {
    const sortBy = $('#sort-by').val();
    
    currentSpecies.sort((a, b) => {
        if (sortBy === 'observation_count') {
            return (parseInt(b.observation_count) || 0) - (parseInt(a.observation_count) || 0);
        } else if (sortBy === 'name') {
            return a.species_name_en.localeCompare(b.species_name_en);
        }
    });
    
    displaySpecies(currentSpecies);
}

function toggleView() {
    if ($('#grid-view').is(':checked')) {
        $('#species-grid').show();
        $('#species-list').hide();
    } else {
        $('#species-grid').hide();
        $('#species-list').show();
    }
}

function showSpeciesDetail(species) {
    selectedSpecies = species;
    
    // 更新模态框标题
    $('#modal-species-title').html(`
        <i class="fas fa-leaf me-2"></i>
        ${species.species_name_en}
    `);
    
    // 更新基本信息
    $('#modal-species-info').html(`
        <div class="mb-3">
            <h6 class="text-primary">Species Name</h6>
            <p class="mb-1"><strong>English: </strong> ${species.species_name_en}</p>
            <p class="mb-1"><strong>German: </strong> ${species.species_name_de}</p>
            <p class="mb-0"><strong>Latin Name: </strong> <em>${species.species_name_la}</em></p>
        </div>
        
        <div class="mb-3">
            <h6 class="text-success">Classification Information</h6>
            <p class="mb-0">
                <span class="badge bg-light text-dark">
                    ${species.group_name || 'Ungrouped'}
                </span>
            </p>
        </div>
        
        <div>
            <h6 class="text-info">Observation Overview</h6>
            <p class="mb-0">
                <span class="badge bg-primary">
                    ${(parseInt(species.observation_count) || 0).toLocaleString()} records
                </span>
            </p>
        </div>
    `);
    
    // 加载该Species的详细数据
    loadSpeciesDetailData(species.id);
    
    // 显示模态框
    $('#speciesModal').modal('show');
}

function loadSpeciesDetailData(speciesId) {
    // 使用新的API获取该Species的所有phases
    $.get(`/api/species-phases/${speciesId}`)
    .done(function(phases) {
        // 创建phase统计对象
        const phaseStats = {};
        phases.forEach(phase => {
            phaseStats[phase.phase_name_en] = phase.observation_count;
        });
        
        // 更新Phenological Phase列表（显示完整的phase列表）
        updatePhasesListComplete(phases);
        
        // 创建Phenological Phase图表
        createPhenologyChart(phaseStats);
        
        // 获取观测数据用于地图和其他统计
        $.get('/api/observations', {
            species_id: speciesId,
            limit: 1000
        })
        .done(function(observations) {
            const stationStats = {};
            
            observations.forEach(obs => {
                const station = obs.station_name;
                if (obs.latitude && obs.longitude) {
                    stationStats[station] = {
                        lat: parseFloat(obs.latitude),
                        lng: parseFloat(obs.longitude),
                        count: (stationStats[station]?.count || 0) + 1
                    };
                }
            });
            
            // 更新统计信息
            updateSpeciesStats(observations, phaseStats, stationStats);
            
            // 创建地图
            createSpeciesMap(stationStats);
        })
        .fail(function() {
            console.error('Failed to load observation data');
        });
    })
    .fail(function() {
        console.error('Failed to load species phases data');
    });
}

function updatePhasesList(phaseStats) {
    const sorted = Object.entries(phaseStats).sort((a, b) => b[1] - a[1]);
    
    let html = '<div class="list-group list-group-flush">';
    sorted.forEach(([phase, count]) => {
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                <span class="small">${phase}</span>
                <span class="badge bg-secondary">${count}</span>
            </div>
        `;
    });
    html += '</div>';
    
    $('#modal-phases-list').html(html);
}

function updatePhasesListComplete(phases) {
    let html = '<div class="list-group list-group-flush">';
    
    phases.forEach(phase => {
        const avgDay = phase.avg_day_of_year ? Math.round(phase.avg_day_of_year) : 'N/A';
        const dateRange = phase.first_year && phase.last_year ? `${phase.first_year}-${phase.last_year}` : '';
        
        html += `
            <div class="list-group-item py-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="small">${phase.phase_name_en}</div>
                        <div class="text-muted small">${phase.phase_name_de}</div>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-secondary">${phase.observation_count}</span>
                        <div class="text-muted small">Day ${avgDay}</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    $('#modal-phases-list').html(html);
}

function updateSpeciesStats(observations, phaseStats, stationStats) {
    const years = [...new Set(observations.map(obs => obs.reference_year))];
    const yearRange = years.length > 0 ? `${Math.min(...years)} - ${Math.max(...years)}` : 'No data';
    
    $('#modal-species-stats').html(`
        <div class="row g-3">
            <div class="col-6">
                <small class="text-muted">Observation Years</small>
                <div class="fw-bold">${years.length} years</div>
            </div>
            <div class="col-6">
                <small class="text-muted">Time Span</small>
                <div class="fw-bold small">${yearRange}</div>
            </div>
            <div class="col-6">
                <small class="text-muted">Number of Phenological Phases</small>
                <div class="fw-bold">${Object.keys(phaseStats).length}</div>
            </div>
            <div class="col-6">
                <small class="text-muted">Observation Stations</small>
                <div class="fw-bold">${Object.keys(stationStats).length}</div>
            </div>
        </div>
    `);
}

function createPhenologyChart(phaseStats) {
    const ctx = document.getElementById('modal-phenology-chart').getContext('2d');
    if (window.modalPhenologyChart) {
        window.modalPhenologyChart.destroy();
    }
    
    const sorted = Object.entries(phaseStats).sort((a, b) => b[1] - a[1]);
    const labels = sorted.map(([phase]) => phase);
    const data = sorted.map(([, count]) => count);
    
    window.modalPhenologyChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Observation Count',
                data: data,
                backgroundColor: '#52b788',
                borderColor: '#2c5234',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                },
                x: {
                    ticks: {
                        maxRotation: 45
                    }
                }
            }
        }
    });
}

function createSpeciesMap(stationStats) {
    // 清理之前的地图
    if (modalMap) {
        modalMap.remove();
    }
    
    // 创建新地图
    modalMap = L.map('modal-species-map').setView([51.1657, 10.4515], 6);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(modalMap);
    
    // 添加Station标记
    Object.entries(stationStats).forEach(([station, data]) => {
        const marker = L.circleMarker([data.lat, data.lng], {
            color: 'white',
            fillColor: '#2c5234',
            fillOpacity: 0.8,
            weight: 1,
            radius: Math.min(data.count / 10, 15) + 3
        }).addTo(modalMap);
        
        marker.bindPopup(`
            <strong>${station}</strong><br>
            Observation Count: ${data.count}
        `);
    });
    
    // Delayed调整地图大小
    setTimeout(() => {
        modalMap.invalidateSize();
    }, 300);
}

function viewSpeciesTimeline() {
    if (selectedSpecies) {
        $('#speciesModal').modal('hide');
        window.location.href = `/timeline?species=${selectedSpecies.id}`;
    }
}

// 模态框关闭时清理地图
$('#speciesModal').on('hidden.bs.modal', function() {
    if (modalMap) {
        modalMap.remove();
        modalMap = null;
    }
});

// 加载所有phases用于筛选
function loadPhasesData() {
    $.get('/api/phases')
        .done(function(phases) {
            // 填充phase筛选器
            phases.forEach(phase => {
                $('#phase-filter').append(`<option value="${phase.id}">${phase.phase_name_en} (${phase.phase_name_de})</option>`);
            });
        })
        .fail(function() {
            console.error('Failed to load phases data');
        });
}

// 根据phase筛选species
function filterSpeciesByPhase() {
    const phaseId = $('#phase-filter').val();
    
    if (!phaseId) {
        // 如果没有选择phase，显示所有species
        currentSpecies = allSpecies;
        sortSpecies();
        return;
    }
    
    // 根据phase获取species
    $.get('/api/species-by-phase', { phase_id: phaseId })
        .done(function(species) {
            // 合并species信息
            const speciesMap = new Map(allSpecies.map(s => [s.id, s]));
            
            currentSpecies = species.map(s => ({
                ...speciesMap.get(s.id),
                ...s
            }));
            
            displaySpecies(currentSpecies);
            
            // 更新species信息显示
            if (species.length > 0) {
                $('#species-info').html(`
                    <p class="mb-2"><strong>Species with selected phase:</strong> ${species.length}</p>
                    <p class="mb-0 text-muted small">Click on a species card to view detailed information</p>
                `);
            } else {
                $('#species-info').html('<p class="text-muted text-center">No species found with the selected phase</p>');
            }
        })
        .fail(function() {
            console.error('Failed to filter species by phase');
            currentSpecies = allSpecies;
            sortSpecies();
        });
}
</script>
{% endblock %}