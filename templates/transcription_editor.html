<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcription Editor - Phenology Mapping</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            overflow: hidden;
        }
        .main-container {
            height: calc(100vh - 56px);
            display: flex;
            flex-direction: column;
        }

        /* Control Bar */
        .control-bar {
            background-color: #2c3e50;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #1a252f;
        }
        .control-bar h5 {
            color: white;
            margin: 0;
        }
        .layout-controls {
            display: flex;
            gap: 0.5rem;
        }
        .layout-btn {
            background-color: #34495e;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .layout-btn:hover {
            background-color: #445566;
        }
        .layout-btn.active {
            background-color: #3498db;
        }

        /* Panel Container */
        .panels-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        .editor-panel {
            flex: 1;
            display: flex;
            flex-direction: row;
            border-right: 2px solid #dee2e6;
            background-color: white;
            overflow: hidden;
        }
        .editor-panel:last-child {
            border-right: none;
        }
        .editor-panel.hidden {
            display: none;
        }
        /* In dual mode, right panel has no sidebar */
        .editor-panel.dual-right .panel-sidebar {
            display: none;
        }

        /* Sidebar */
        .panel-sidebar {
            width: 280px;
            background-color: #ecf0f1;
            border-right: 1px solid #bdc3c7;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .sidebar-header {
            padding: 1rem;
            background-color: #34495e;
            color: white;
            font-weight: bold;
        }
        .folder-item {
            cursor: pointer;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #d5d8dc;
            transition: background-color 0.2s;
        }
        .folder-item:hover {
            background-color: #d5d8dc;
        }
        .folder-item.active {
            background-color: #3498db;
            color: white;
        }
        .folder-info {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }

        /* Content Area */
        .panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .content-header {
            padding: 1rem;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-tabs {
            padding: 0.5rem 1rem;
            background-color: white;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
        }
        .file-tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border: none;
            background: #f8f9fa;
            border-radius: 4px 4px 0 0;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .file-tab:hover {
            background-color: #e9ecef;
        }
        .file-tab.active {
            background-color: #3498db;
            color: white;
        }
        .content-body {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }
        .image-container {
            position: relative;
            overflow: hidden;
            border: 1px solid #dee2e6;
            background-color: #f5f5f5;
            max-height: calc(100vh - 300px);
            min-height: 400px;
        }
        .tif-preview {
            display: block;
            transform-origin: 0 0;
            cursor: grab;
            user-select: none;
            -webkit-user-drag: none;
        }
        .tif-preview:active {
            cursor: grabbing;
        }
        .image-loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(245, 245, 245, 0.9);
            z-index: 5;
        }
        .image-loading-overlay .spinner-border {
            width: 3rem;
            height: 3rem;
            color: #3498db;
        }
        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 4px;
            padding: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .zoom-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        .zoom-btn:hover {
            background-color: #2980b9;
        }
        .zoom-level {
            display: inline-block;
            margin: 0 5px;
            font-size: 14px;
            min-width: 50px;
            text-align: center;
        }
        .table-preview table {
            font-size: 0.875rem;
        }
        .odt-editor {
            width: 100%;
            min-height: 300px;
            font-family: monospace;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #7f8c8d;
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        /* Annotations */
        .annotation-item {
            background-color: #f8f9fa;
            border-left: 3px solid #3498db;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .annotation-text {
            margin: 0;
            color: #2c3e50;
        }
        .annotation-time {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-leaf"></i> Phenology Mapping
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/transcription-editor">Transcription Editor</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Control Bar -->
        <div class="control-bar">
            <h5><i class="fas fa-edit"></i> Transcription Editor</h5>
            <div class="layout-controls">
                <button class="layout-btn active" onclick="setLayout('single')" data-layout="single">
                    <i class="fas fa-square"></i> Single Panel
                </button>
                <button class="layout-btn" onclick="setLayout('dual')" data-layout="dual">
                    <i class="fas fa-columns"></i> Dual Panel
                </button>
                <button class="layout-btn" onclick="showSpeciesMapping()">
                    <i class="fas fa-dna"></i> Species Mapping
                </button>
            </div>
        </div>

        <!-- Panels Container -->
        <div class="panels-container">
            <!-- Left Panel -->
            <div class="editor-panel" id="panel-left">
                <div class="panel-sidebar">
                    <div class="sidebar-header">
                        Folders
                    </div>
                    <div id="folder-list-left">
                        <!-- Folders will be loaded here -->
                    </div>
                </div>
                <div class="panel-content">
                    <div class="content-header">
                        <h5 class="mb-0" id="folder-name-left">No folder selected</h5>
                    </div>
                    <div class="file-tabs" id="file-tabs-left">
                        <!-- File tabs will be here -->
                    </div>
                    <div class="content-body" id="content-left">
                        <div class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <h5>Select a folder to begin</h5>
                            <p>Choose a folder from the sidebar to view and edit its contents</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel (used in dual mode for TIF image) -->
            <div class="editor-panel hidden dual-right" id="panel-right">
                <div class="panel-sidebar">
                    <div class="sidebar-header">
                        Folders (Panel 2)
                    </div>
                    <div id="folder-list-right">
                    </div>
                </div>
                <div class="panel-content">
                    <div class="content-header">
                        <h5 class="mb-0" id="folder-name-right">TIF Image</h5>
                    </div>
                    <div class="file-tabs" id="file-tabs-right">
                    </div>
                    <div class="content-body" id="content-right">
                        <div class="empty-state">
                            <i class="fas fa-image"></i>
                            <h5>Select a folder to view TIF image</h5>
                            <p>In dual mode, the TIF image will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let folders = [];
        let currentLayout = 'single';

        // State for each panel
        let panelState = {
            left: { folder: null, currentFile: null, tables: [] },
            right: { folder: null, currentFile: null, tables: [] }
        };

        $(document).ready(function() {
            loadFolders();
        });

        function loadFolders() {
            $.get('/api/transcription/folders', function(data) {
                folders = data.sort((a, b) => {
                    const indexA = parseInt(a.index) || 999999;
                    const indexB = parseInt(b.index) || 999999;
                    return indexA - indexB;
                });

                renderFolderList('left');
                renderFolderList('right');
            });
        }

        function renderFolderList(panelId) {
            const container = $(`#folder-list-${panelId}`);
            container.empty();

            folders.forEach(folder => {
                const item = $(`
                    <div class="folder-item" data-folder="${folder.name}">
                        <div><strong>${folder.name}</strong></div>
                        <div class="folder-info">
                            ${folder.hasOdt ? '<i class="fas fa-file-alt"></i>' : ''}
                            ${folder.hasTif ? '<i class="fas fa-image"></i>' : ''}
                            ${folder.isTabelle ? '<span class="badge bg-primary">Table</span>' : ''}
                            <span class="float-end">#${folder.index || '-'}</span>
                        </div>
                    </div>
                `);

                item.click(function() {
                    selectFolder(panelId, folder.name);
                });

                container.append(item);
            });
        }

        function selectFolder(panelId, folderName) {
            panelState[panelId].folder = folderName;
            panelState[panelId].currentFile = null;
            panelState[panelId].tables = [];

            // Update UI
            $(`#folder-list-${panelId} .folder-item`).removeClass('active');
            $(`#folder-list-${panelId} .folder-item[data-folder="${folderName}"]`).addClass('active');
            $(`#folder-name-${panelId}`).text(folderName);

            if (currentLayout === 'dual' && panelId === 'left') {
                // In dual mode, left panel shows ODT, right panel shows TIF
                loadDualMode(folderName);
            } else {
                // Single mode: load folder contents with file tabs
                loadFolderContents(panelId, folderName);
            }
        }

        function loadDualMode(folderName) {
            // Load folder contents and split: ODT in left, TIF in right
            $.get(`/api/transcription/folder/${encodeURIComponent(folderName)}`, function(data) {
                const odtFile = data.files.find(f => f.type === 'odt');
                const tifFile = data.files.find(f => f.type === 'tif');

                // Left panel: show ODT table
                const leftTabs = $('#file-tabs-left');
                leftTabs.empty();
                if (odtFile) {
                    leftTabs.append(`<button class="file-tab active"><i class="fas fa-file-alt"></i> ${odtFile.name}</button>`);
                    loadOdtContent('left', odtFile);
                } else {
                    $('#content-left').html('<div class="empty-state"><i class="fas fa-file-alt"></i><h5>No ODT file in this folder</h5></div>');
                }

                // Right panel: show TIF image
                $('#folder-name-right').text(folderName + ' - TIF Image');
                const rightTabs = $('#file-tabs-right');
                rightTabs.empty();
                if (tifFile) {
                    rightTabs.append(`<button class="file-tab active"><i class="fas fa-image"></i> ${tifFile.name}</button>`);
                    showTifImage('right', folderName, tifFile);
                } else {
                    $('#content-right').html('<div class="empty-state"><i class="fas fa-image"></i><h5>No TIF file in this folder</h5></div>');
                }
            });
        }

        function showTifImage(panelId, folderName, file) {
            panelState[panelId].currentFile = file;
            panelState[panelId].folder = folderName;
            const contentArea = $(`#content-${panelId}`);
            contentArea.empty();

            contentArea.html(`
                <div class="image-container" id="image-container-${panelId}">
                    <div class="image-loading-overlay" id="image-loading-${panelId}">
                        <div class="spinner-border" role="status"></div>
                        <p class="mt-2 text-muted">Loading image...</p>
                    </div>
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="zoomImage('${panelId}', 'in')"><i class="fas fa-search-plus"></i></button>
                        <span class="zoom-level" id="zoom-level-${panelId}">Fit</span>
                        <button class="zoom-btn" onclick="zoomImage('${panelId}', 'out')"><i class="fas fa-search-minus"></i></button>
                        <button class="zoom-btn" onclick="zoomImage('${panelId}', 'fit')" title="Fit to window"><i class="fas fa-expand"></i></button>
                    </div>
                    <img class="tif-preview" id="tif-image-${panelId}" src="/api/transcription/image/${encodeURIComponent(folderName)}/${encodeURIComponent(file.name)}" alt="TIF preview">
                </div>
            `);

            panelState[panelId].zoom = { level: 1, panX: 0, panY: 0 };
            initImageViewer(panelId);
        }

        function loadFolderContents(panelId, folderName) {
            $.get(`/api/transcription/folder/${encodeURIComponent(folderName)}`, function(data) {
                const fileTabs = $(`#file-tabs-${panelId}`);
                fileTabs.empty();

                data.files.forEach((file, index) => {
                    const fileTab = $(`
                        <button class="file-tab ${index === 0 ? 'active' : ''}" data-file="${file.name}">
                            ${file.type === 'tif' ? '<i class="fas fa-image"></i>' : '<i class="fas fa-file-alt"></i>'}
                            ${file.name}
                        </button>
                    `);

                    fileTab.click(function() {
                        showFile(panelId, file);
                    });

                    fileTabs.append(fileTab);
                });

                if (data.files.length > 0) {
                    showFile(panelId, data.files[0]);
                }
            });
        }

        function showFile(panelId, file) {
            panelState[panelId].currentFile = file;

            // Update active tab
            $(`#file-tabs-${panelId} .file-tab`).removeClass('active');
            $(`#file-tabs-${panelId} .file-tab[data-file="${file.name}"]`).addClass('active');

            const contentArea = $(`#content-${panelId}`);
            contentArea.empty();

            if (file.type === 'tif') {
                const folderName = panelState[panelId].folder;
                contentArea.html(`
                    <h5>Scanned Image Preview</h5>
                    <div class="image-container" id="image-container-${panelId}">
                        <div class="image-loading-overlay" id="image-loading-${panelId}">
                            <div class="spinner-border" role="status"></div>
                            <p class="mt-2 text-muted">Loading image...</p>
                        </div>
                        <div class="zoom-controls">
                            <button class="zoom-btn" onclick="zoomImage('${panelId}', 'in')"><i class="fas fa-search-plus"></i></button>
                            <span class="zoom-level" id="zoom-level-${panelId}">Fit</span>
                            <button class="zoom-btn" onclick="zoomImage('${panelId}', 'out')"><i class="fas fa-search-minus"></i></button>
                            <button class="zoom-btn" onclick="zoomImage('${panelId}', 'fit')" title="Fit to window"><i class="fas fa-expand"></i></button>
                        </div>
                        <img class="tif-preview" id="tif-image-${panelId}" src="/api/transcription/image/${encodeURIComponent(folderName)}/${encodeURIComponent(file.name)}" alt="TIF preview">
                    </div>
                    <div class="mt-3">
                        <h6>Annotations</h6>
                        <div id="annotations-${panelId}" class="mb-3">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            Loading annotations...
                        </div>
                        <div class="input-group">
                            <input type="text" class="form-control" id="new-annotation-${panelId}" placeholder="Add a new annotation..." onkeypress="if(event.key==='Enter') addAnnotation('${panelId}')">
                            <button class="btn btn-primary" onclick="addAnnotation('${panelId}')"><i class="fas fa-plus"></i> Add</button>
                        </div>
                    </div>
                `);

                // Initialize image viewer
                panelState[panelId].zoom = { level: 1, panX: 0, panY: 0 };
                initImageViewer(panelId);

                // Load existing annotations
                loadAnnotations(panelId, folderName, file.name);
            } else if (file.type === 'odt') {
                loadOdtContent(panelId, file);
            }
        }

        // Get cell text (handles both plain strings and {text, colspan} objects)
        function getCellText(cell) {
            if (typeof cell === 'object' && cell !== null) return cell.text || '';
            return cell || '';
        }

        // Get cell colspan
        function getCellColspan(cell) {
            if (typeof cell === 'object' && cell !== null) return cell.colspan || 1;
            return 1;
        }

        // Get cell rowspan
        function getCellRowspan(cell) {
            if (typeof cell === 'object' && cell !== null) return cell.rowspan || 1;
            return 1;
        }

        // Build span attributes string for a cell
        function getSpanAttrs(cell) {
            let attrs = '';
            const cs = getCellColspan(cell);
            const rs = getCellRowspan(cell);
            if (cs > 1) attrs += ` colspan="${cs}"`;
            if (rs > 1) attrs += ` rowspan="${rs}"`;
            return attrs;
        }

        // Count logical columns in a row (sum of colspans)
        function getLogicalColCount(row) {
            return row.reduce((sum, cell) => sum + getCellColspan(cell), 0);
        }

        // Merge consecutive header+data tables in ODT
        function mergeTables(tables) {
            if (!tables || tables.length < 2) return tables;

            const merged = [];
            let i = 0;
            while (i < tables.length) {
                // Check if this table is a header (exactly 2 rows) and next table is data
                if (i + 1 < tables.length &&
                    tables[i].length === 2 &&
                    tables[i + 1].length > 0) {
                    // Compare logical column counts (accounting for colspans)
                    const headerLogicalCols = getLogicalColCount(tables[i][0]);
                    const dataLogicalCols = getLogicalColCount(tables[i + 1][0]);
                    if (headerLogicalCols === dataLogicalCols) {
                        const mergedTable = [...tables[i], ...tables[i + 1]];
                        mergedTable._headerRows = 2;
                        merged.push(mergedTable);
                        i += 2;
                        continue;
                    }
                }
                merged.push(tables[i]);
                i++;
            }
            return merged;
        }

        function loadOdtContent(panelId, file) {
            const folderName = panelState[panelId].folder;

            $.get(`/api/transcription/odt/${encodeURIComponent(folderName)}/${encodeURIComponent(file.name)}`, function(data) {
                let tables = data.tables || [];
                // Merge header+data tables
                tables = mergeTables(tables);
                panelState[panelId].tables = tables;

                const contentArea = $(`#content-${panelId}`);
                contentArea.empty();

                let html = '<h5>ODT File Content</h5>';

                if (tables.length > 0) {
                    html += '<div class="table-preview">';
                    tables.forEach((table, tIndex) => {
                        const headerRows = table._headerRows || 1;
                        html += `<h6>Table ${tIndex + 1}</h6>`;
                        html += `<table class="table table-bordered table-sm" data-table="${tIndex}">`;
                        html += '<thead>';
                        table.forEach((row, rIndex) => {
                            if (rIndex < headerRows) {
                                html += '<tr>';
                                row.forEach(cell => {
                                    html += `<th${getSpanAttrs(cell)}>${getCellText(cell) || '-'}</th>`;
                                });
                                html += '</tr>';
                            }
                        });
                        html += '</thead><tbody>';
                        table.forEach((row, rIndex) => {
                            if (rIndex >= headerRows) {
                                html += '<tr>';
                                row.forEach(cell => {
                                    html += `<td${getSpanAttrs(cell)}>${getCellText(cell) || '-'}</td>`;
                                });
                                html += '</tr>';
                            }
                        });
                        html += '</tbody></table>';
                    });
                    html += '</div>';
                } else {
                    html += '<div class="alert alert-info">No tables found</div>';
                }

                html += `<div class="mt-3"><label>Raw Text:</label><textarea class="odt-editor" readonly>${data.raw_content}</textarea></div>`;

                // Add annotations section
                html += `
                    <div class="mt-4">
                        <h6>Annotations</h6>
                        <div id="annotations-${panelId}" class="mb-3">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            Loading annotations...
                        </div>
                        <div class="input-group">
                            <input type="text" class="form-control" id="new-annotation-${panelId}" placeholder="Add a new annotation..." onkeypress="if(event.key==='Enter') addAnnotation('${panelId}')">
                            <button class="btn btn-primary" onclick="addAnnotation('${panelId}')"><i class="fas fa-plus"></i> Add</button>
                        </div>
                    </div>
                `;

                contentArea.html(html);

                // Load existing annotations
                loadAnnotations(panelId, folderName, file.name);
            });
        }

        // Species Mapping viewer
        function showSpeciesMapping() {
            // Show species mapping in the left panel content area
            const contentArea = $('#content-left');
            const fileTabs = $('#file-tabs-left');
            fileTabs.empty();
            fileTabs.append('<button class="file-tab active"><i class="fas fa-dna"></i> Species Mapping</button>');
            $('#folder-name-left').text('Species Mapping');

            contentArea.html(`
                <div class="text-center py-3">
                    <div class="spinner-border" role="status"></div>
                    <p class="mt-2 text-muted">Loading species mapping data...</p>
                </div>
            `);

            $.get('/api/species-mapping', function(data) {
                if (!data.data || data.data.length === 0) {
                    contentArea.html('<div class="alert alert-info">No species mapping data found.</div>');
                    return;
                }

                const rows = data.data;
                const headers = Object.keys(rows[0]);

                let html = '<h5>Species Mapping Table</h5>';
                html += '<div class="table-preview" style="max-height: calc(100vh - 300px); overflow-y: auto;">';
                html += '<table class="table table-bordered table-sm table-striped">';
                html += '<thead class="table-dark"><tr>';
                headers.forEach(h => {
                    html += `<th>${h}</th>`;
                });
                html += '</tr></thead><tbody>';
                rows.forEach(row => {
                    html += '<tr>';
                    headers.forEach(h => {
                        html += `<td>${row[h] || '-'}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table></div>';

                // Add annotations section for species mapping
                html += `
                    <div class="mt-4">
                        <h6>Annotations</h6>
                        <div id="annotations-left" class="mb-3">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            Loading annotations...
                        </div>
                        <div class="input-group">
                            <input type="text" class="form-control" id="new-annotation-left" placeholder="Add a new annotation..." onkeypress="if(event.key==='Enter') addAnnotation('left')">
                            <button class="btn btn-primary" onclick="addAnnotation('left')"><i class="fas fa-plus"></i> Add</button>
                        </div>
                    </div>
                `;

                contentArea.html(html);

                // Set state for annotation support
                panelState.left.folder = 'species_mapping';
                panelState.left.currentFile = { name: 'species_mapping', type: 'csv' };

                loadAnnotations('left', 'species_mapping', 'species_mapping');
            }).fail(function() {
                contentArea.html('<div class="alert alert-danger">Failed to load species mapping data.</div>');
            });
        }

        function zoomImage(panelId, action) {
            const state = panelState[panelId];
            if (!state.zoom) state.zoom = { level: 1, panX: 0, panY: 0 };

            const img = $(`#tif-image-${panelId}`);
            const container = $(`#image-container-${panelId}`);

            if (action === 'fit') {
                // Fit image to container
                const cw = container.width();
                const ch = container.height();
                const iw = img[0].naturalWidth || img.width();
                const ih = img[0].naturalHeight || img.height();
                if (iw && ih) {
                    state.zoom.level = Math.min(cw / iw, ch / ih, 1);
                    // Center the image
                    state.zoom.panX = (cw - iw * state.zoom.level) / 2;
                    state.zoom.panY = (ch - ih * state.zoom.level) / 2;
                }
                $(`#zoom-level-${panelId}`).text('Fit');
            } else {
                // Zoom towards center of container
                const cw = container.width();
                const ch = container.height();
                const oldLevel = state.zoom.level;
                let newLevel;

                if (action === 'in') {
                    newLevel = Math.min(oldLevel * 1.25, 5);
                } else {
                    newLevel = Math.max(oldLevel / 1.25, 0.1);
                }

                // Zoom around the center of the visible area
                const cx = cw / 2;
                const cy = ch / 2;
                state.zoom.panX = cx - (cx - state.zoom.panX) * (newLevel / oldLevel);
                state.zoom.panY = cy - (cy - state.zoom.panY) * (newLevel / oldLevel);
                state.zoom.level = newLevel;
                $(`#zoom-level-${panelId}`).text(Math.round(newLevel * 100) + '%');
            }

            applyTransform(panelId);
        }

        function applyTransform(panelId) {
            const state = panelState[panelId];
            const img = $(`#tif-image-${panelId}`);
            img.css('transform', `translate(${state.zoom.panX}px, ${state.zoom.panY}px) scale(${state.zoom.level})`);
        }

        function initImageViewer(panelId) {
            const container = $(`#image-container-${panelId}`);
            const img = $(`#tif-image-${panelId}`);
            let isDragging = false;
            let lastX, lastY;

            // Show loading overlay, hide when image loads
            img.on('load', function() {
                $(`#image-loading-${panelId}`).fadeOut(300);
                // Auto fit on first load
                zoomImage(panelId, 'fit');
            });

            // If image fails to load
            img.on('error', function() {
                $(`#image-loading-${panelId}`).html('<p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Failed to load image</p>');
            });

            // Mouse drag to pan
            img.on('mousedown', function(e) {
                e.preventDefault();
                isDragging = true;
                lastX = e.clientX;
                lastY = e.clientY;
            });

            $(document).on('mouseup.imgdrag' + panelId, function() {
                isDragging = false;
            });

            $(document).on('mousemove.imgdrag' + panelId, function(e) {
                if (!isDragging) return;
                e.preventDefault();
                const state = panelState[panelId];
                const dx = e.clientX - lastX;
                const dy = e.clientY - lastY;
                lastX = e.clientX;
                lastY = e.clientY;
                state.zoom.panX += dx;
                state.zoom.panY += dy;
                applyTransform(panelId);
            });

            // Mouse wheel zoom towards cursor
            container.on('wheel', function(e) {
                e.preventDefault();
                const state = panelState[panelId];
                const oldLevel = state.zoom.level;
                let newLevel;

                if (e.originalEvent.deltaY < 0) {
                    newLevel = Math.min(oldLevel * 1.15, 5);
                } else {
                    newLevel = Math.max(oldLevel / 1.15, 0.1);
                }

                // Zoom towards mouse cursor position
                const rect = container[0].getBoundingClientRect();
                const mx = e.clientX - rect.left;
                const my = e.clientY - rect.top;

                state.zoom.panX = mx - (mx - state.zoom.panX) * (newLevel / oldLevel);
                state.zoom.panY = my - (my - state.zoom.panY) * (newLevel / oldLevel);
                state.zoom.level = newLevel;

                applyTransform(panelId);
                $(`#zoom-level-${panelId}`).text(Math.round(newLevel * 100) + '%');
            });
        }

        function loadAnnotations(panelId, folderName, fileName) {
            $.get(`/api/transcription/annotations/${encodeURIComponent(folderName)}/${encodeURIComponent(fileName)}`, function(data) {
                const container = $(`#annotations-${panelId}`);
                container.empty();

                if (data.annotations && data.annotations.length > 0) {
                    data.annotations.forEach(ann => {
                        const time = new Date(ann.created_at).toLocaleString();
                        container.append(`
                            <div class="annotation-item">
                                <p class="annotation-text">${ann.annotation_text}</p>
                                <div class="annotation-time"><i class="fas fa-clock"></i> ${time}</div>
                            </div>
                        `);
                    });
                } else {
                    container.html('<p class="text-muted">No annotations yet.</p>');
                }
            }).fail(function() {
                $(`#annotations-${panelId}`).html('<p class="text-danger">Failed to load annotations.</p>');
            });
        }

        function addAnnotation(panelId) {
            const state = panelState[panelId];
            const input = $(`#new-annotation-${panelId}`);
            const annotationText = input.val().trim();

            if (!annotationText) {
                alert('Please enter an annotation.');
                return;
            }

            if (!state.folder || !state.currentFile) {
                alert('No file selected.');
                return;
            }

            $.ajax({
                url: '/api/transcription/annotations',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    folder_name: state.folder,
                    file_name: state.currentFile.name,
                    annotation_text: annotationText
                }),
                success: function() {
                    input.val('');
                    loadAnnotations(panelId, state.folder, state.currentFile.name);
                },
                error: function(error) {
                    alert('Failed to save annotation: ' + (error.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        function setLayout(layout) {
            currentLayout = layout;

            $('.layout-btn').removeClass('active');
            $(`.layout-btn[data-layout="${layout}"]`).addClass('active');

            if (layout === 'single') {
                $('#panel-right').addClass('hidden');
                // Restore left panel sidebar header
                $('#panel-left .sidebar-header').text('Folders');
            } else {
                $('#panel-right').removeClass('hidden');
                $('#panel-left .sidebar-header').text('Folders');
                // If a folder is already selected in left panel, load dual mode
                const currentFolder = panelState.left.folder;
                if (currentFolder) {
                    loadDualMode(currentFolder);
                }
            }
        }
    </script>
</body>
</html>
