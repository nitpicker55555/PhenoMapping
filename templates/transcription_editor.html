<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcription Editor - Phenology Mapping</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            overflow: hidden;
        }
        .main-container {
            height: calc(100vh - 56px);
            display: flex;
            flex-direction: column;
        }

        /* Control Bar */
        .control-bar {
            background-color: #2c3e50;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #1a252f;
        }
        .control-bar h5 {
            color: white;
            margin: 0;
        }
        .layout-controls {
            display: flex;
            gap: 0.5rem;
        }
        .layout-btn {
            background-color: #34495e;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .layout-btn:hover {
            background-color: #445566;
        }
        .layout-btn.active {
            background-color: #3498db;
        }

        /* Panel Container */
        .panels-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        .editor-panel {
            flex: 1;
            display: flex;
            flex-direction: row;
            border-right: 2px solid #dee2e6;
            background-color: white;
            overflow: hidden;
        }
        .editor-panel:last-child {
            border-right: none;
        }
        .editor-panel.hidden {
            display: none;
        }

        /* Sidebar */
        .panel-sidebar {
            width: 280px;
            background-color: #ecf0f1;
            border-right: 1px solid #bdc3c7;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .sidebar-header {
            padding: 1rem;
            background-color: #34495e;
            color: white;
            font-weight: bold;
        }
        .folder-item {
            cursor: pointer;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #d5d8dc;
            transition: background-color 0.2s;
        }
        .folder-item:hover {
            background-color: #d5d8dc;
        }
        .folder-item.active {
            background-color: #3498db;
            color: white;
        }
        .folder-info {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }

        /* Content Area */
        .panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .content-header {
            padding: 1rem;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-tabs {
            padding: 0.5rem 1rem;
            background-color: white;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
        }
        .file-tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border: none;
            background: #f8f9fa;
            border-radius: 4px 4px 0 0;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .file-tab:hover {
            background-color: #e9ecef;
        }
        .file-tab.active {
            background-color: #3498db;
            color: white;
        }
        .content-body {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }
        .image-container {
            position: relative;
            overflow: auto;
            border: 1px solid #dee2e6;
            background-color: #f5f5f5;
            max-height: calc(100vh - 300px);
        }
        .tif-preview {
            display: block;
            margin: 0 auto;
            cursor: grab;
            transition: transform 0.1s;
        }
        .tif-preview:active {
            cursor: grabbing;
        }
        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 4px;
            padding: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .zoom-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        .zoom-btn:hover {
            background-color: #2980b9;
        }
        .zoom-level {
            display: inline-block;
            margin: 0 5px;
            font-size: 14px;
            min-width: 50px;
            text-align: center;
        }
        .table-preview table {
            font-size: 0.875rem;
        }
        .odt-editor {
            width: 100%;
            min-height: 300px;
            font-family: monospace;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #7f8c8d;
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        /* Annotations */
        .annotation-item {
            background-color: #f8f9fa;
            border-left: 3px solid #3498db;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .annotation-text {
            margin: 0;
            color: #2c3e50;
        }
        .annotation-time {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-leaf"></i> Phenology Mapping
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/transcription-editor">Transcription Editor</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Control Bar -->
        <div class="control-bar">
            <h5><i class="fas fa-edit"></i> Transcription Editor</h5>
            <div class="layout-controls">
                <button class="layout-btn active" onclick="setLayout('single')">
                    <i class="fas fa-square"></i> Single Panel
                </button>
                <button class="layout-btn" onclick="setLayout('dual')">
                    <i class="fas fa-columns"></i> Dual Panel
                </button>
            </div>
        </div>

        <!-- Panels Container -->
        <div class="panels-container">
            <!-- Left Panel -->
            <div class="editor-panel" id="panel-left">
                <div class="panel-sidebar">
                    <div class="sidebar-header">
                        Folders (Panel 1)
                    </div>
                    <div id="folder-list-left">
                        <!-- Folders will be loaded here -->
                    </div>
                </div>
                <div class="panel-content">
                    <div class="content-header">
                        <h5 class="mb-0" id="folder-name-left">No folder selected</h5>
                    </div>
                    <div class="file-tabs" id="file-tabs-left">
                        <!-- File tabs will be here -->
                    </div>
                    <div class="content-body" id="content-left">
                        <div class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <h5>Select a folder to begin</h5>
                            <p>Choose a folder from the sidebar to view and edit its contents</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="editor-panel hidden" id="panel-right">
                <div class="panel-sidebar">
                    <div class="sidebar-header">
                        Folders (Panel 2)
                    </div>
                    <div id="folder-list-right">
                        <!-- Folders will be loaded here -->
                    </div>
                </div>
                <div class="panel-content">
                    <div class="content-header">
                        <h5 class="mb-0" id="folder-name-right">No folder selected</h5>
                    </div>
                    <div class="file-tabs" id="file-tabs-right">
                        <!-- File tabs will be here -->
                    </div>
                    <div class="content-body" id="content-right">
                        <div class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <h5>Select a folder to begin</h5>
                            <p>Choose a folder from the sidebar to view and edit its contents</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let folders = [];
        let currentLayout = 'single';

        // State for each panel
        let panelState = {
            left: { folder: null, currentFile: null, tables: [] },
            right: { folder: null, currentFile: null, tables: [] }
        };

        $(document).ready(function() {
            loadFolders();
        });

        function loadFolders() {
            $.get('/api/transcription/folders', function(data) {
                folders = data.sort((a, b) => {
                    const indexA = parseInt(a.index) || 999999;
                    const indexB = parseInt(b.index) || 999999;
                    return indexA - indexB;
                });

                renderFolderList('left');
                renderFolderList('right');
            });
        }

        function renderFolderList(panelId) {
            const container = $(`#folder-list-${panelId}`);
            container.empty();

            folders.forEach(folder => {
                const item = $(`
                    <div class="folder-item" data-folder="${folder.name}">
                        <div><strong>${folder.name}</strong></div>
                        <div class="folder-info">
                            ${folder.hasOdt ? '<i class="fas fa-file-alt"></i>' : ''}
                            ${folder.hasTif ? '<i class="fas fa-image"></i>' : ''}
                            ${folder.isTabelle ? '<span class="badge bg-primary">Table</span>' : ''}
                            <span class="float-end">#${folder.index || '-'}</span>
                        </div>
                    </div>
                `);

                item.click(function() {
                    selectFolder(panelId, folder.name);
                });

                container.append(item);
            });
        }

        function selectFolder(panelId, folderName) {
            panelState[panelId].folder = folderName;
            panelState[panelId].currentFile = null;
            panelState[panelId].tables = [];

            // Update UI
            $(`#folder-list-${panelId} .folder-item`).removeClass('active');
            $(`#folder-list-${panelId} .folder-item[data-folder="${folderName}"]`).addClass('active');
            $(`#folder-name-${panelId}`).text(folderName);

            // Load folder contents
            loadFolderContents(panelId, folderName);
        }

        function loadFolderContents(panelId, folderName) {
            $.get(`/api/transcription/folder/${encodeURIComponent(folderName)}`, function(data) {
                const fileTabs = $(`#file-tabs-${panelId}`);
                fileTabs.empty();

                data.files.forEach((file, index) => {
                    const fileTab = $(`
                        <button class="file-tab ${index === 0 ? 'active' : ''}" data-file="${file.name}">
                            ${file.type === 'tif' ? '<i class="fas fa-image"></i>' : '<i class="fas fa-file-alt"></i>'}
                            ${file.name}
                        </button>
                    `);

                    fileTab.click(function() {
                        showFile(panelId, file);
                    });

                    fileTabs.append(fileTab);
                });

                if (data.files.length > 0) {
                    showFile(panelId, data.files[0]);
                }
            });
        }

        function showFile(panelId, file) {
            panelState[panelId].currentFile = file;

            // Update active tab
            $(`#file-tabs-${panelId} .file-tab`).removeClass('active');
            $(`#file-tabs-${panelId} .file-tab[data-file="${file.name}"]`).addClass('active');

            const contentArea = $(`#content-${panelId}`);
            contentArea.empty();

            if (file.type === 'tif') {
                const folderName = panelState[panelId].folder;
                contentArea.html(`
                    <h5>Scanned Image Preview</h5>
                    <div class="image-container" id="image-container-${panelId}">
                        <div class="zoom-controls">
                            <button class="zoom-btn" onclick="zoomImage('${panelId}', 'in')"><i class="fas fa-search-plus"></i></button>
                            <span class="zoom-level" id="zoom-level-${panelId}">100%</span>
                            <button class="zoom-btn" onclick="zoomImage('${panelId}', 'out')"><i class="fas fa-search-minus"></i></button>
                            <button class="zoom-btn" onclick="zoomImage('${panelId}', 'reset')"><i class="fas fa-undo"></i></button>
                        </div>
                        <img class="tif-preview" id="tif-image-${panelId}" src="/api/transcription/image/${encodeURIComponent(folderName)}/${encodeURIComponent(file.name)}" alt="TIF preview">
                    </div>
                    <div class="mt-3">
                        <h6>Annotations</h6>
                        <div id="annotations-${panelId}" class="mb-3">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            Loading annotations...
                        </div>
                        <div class="input-group">
                            <input type="text" class="form-control" id="new-annotation-${panelId}" placeholder="Add a new annotation..." onkeypress="if(event.key==='Enter') addAnnotation('${panelId}')">
                            <button class="btn btn-primary" onclick="addAnnotation('${panelId}')"><i class="fas fa-plus"></i> Add</button>
                        </div>
                    </div>
                `);

                // Initialize zoom state
                panelState[panelId].zoom = { level: 1, x: 0, y: 0 };

                // Enable image dragging
                enableImageDragging(panelId);

                // Load existing annotations
                loadAnnotations(panelId, folderName, file.name);
            } else if (file.type === 'odt') {
                loadOdtContent(panelId, file);
            }
        }

        function loadOdtContent(panelId, file) {
            const folderName = panelState[panelId].folder;

            $.get(`/api/transcription/odt/${encodeURIComponent(folderName)}/${encodeURIComponent(file.name)}`, function(data) {
                panelState[panelId].tables = data.tables || [];

                const contentArea = $(`#content-${panelId}`);
                contentArea.empty();

                let html = '<h5>ODT File Content</h5>';

                if (panelState[panelId].tables.length > 0) {
                    html += '<div class="table-preview">';
                    panelState[panelId].tables.forEach((table, tIndex) => {
                        html += `<h6>Table ${tIndex + 1}</h6>`;
                        html += `<table class="table table-bordered table-sm" data-table="${tIndex}">`;
                        table.forEach((row, rIndex) => {
                            html += '<tr>';
                            row.forEach((cell, cIndex) => {
                                const tag = rIndex === 0 ? 'th' : 'td';
                                html += `<${tag}>${cell || '-'}</${tag}>`;
                            });
                            html += '</tr>';
                        });
                        html += '</table>';
                    });
                    html += '</div>';
                } else {
                    html += '<div class="alert alert-info">No tables found</div>';
                }

                html += `<div class="mt-3"><label>Raw Text:</label><textarea class="odt-editor" readonly>${data.raw_content}</textarea></div>`;

                // Add annotations section
                html += `
                    <div class="mt-4">
                        <h6>Annotations</h6>
                        <div id="annotations-${panelId}" class="mb-3">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            Loading annotations...
                        </div>
                        <div class="input-group">
                            <input type="text" class="form-control" id="new-annotation-${panelId}" placeholder="Add a new annotation..." onkeypress="if(event.key==='Enter') addAnnotation('${panelId}')">
                            <button class="btn btn-primary" onclick="addAnnotation('${panelId}')"><i class="fas fa-plus"></i> Add</button>
                        </div>
                    </div>
                `;

                contentArea.html(html);

                // Load existing annotations
                loadAnnotations(panelId, folderName, file.name);
            });
        }

        function zoomImage(panelId, action) {
            const state = panelState[panelId];
            if (!state.zoom) state.zoom = { level: 1, x: 0, y: 0 };

            const img = $(`#tif-image-${panelId}`);
            let newLevel = state.zoom.level;

            if (action === 'in') {
                newLevel = Math.min(state.zoom.level + 0.2, 3);
            } else if (action === 'out') {
                newLevel = Math.max(state.zoom.level - 0.2, 0.5);
            } else if (action === 'reset') {
                newLevel = 1;
            }

            state.zoom.level = newLevel;
            img.css('transform', `scale(${newLevel})`);
            $(`#zoom-level-${panelId}`).text(Math.round(newLevel * 100) + '%');
        }

        function enableImageDragging(panelId) {
            const container = $(`#image-container-${panelId}`);
            const img = $(`#tif-image-${panelId}`);
            let isDragging = false;
            let startX, startY, scrollLeft, scrollTop;

            img.on('mousedown', function(e) {
                isDragging = true;
                startX = e.pageX - container.offset().left;
                startY = e.pageY - container.offset().top;
                scrollLeft = container.scrollLeft();
                scrollTop = container.scrollTop();
            });

            $(document).on('mouseup', function() {
                isDragging = false;
            });

            container.on('mousemove', function(e) {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.pageX - container.offset().left;
                const y = e.pageY - container.offset().top;
                const walkX = (x - startX) * 2;
                const walkY = (y - startY) * 2;
                container.scrollLeft(scrollLeft - walkX);
                container.scrollTop(scrollTop - walkY);
            });

            // Mouse wheel zoom
            container.on('wheel', function(e) {
                e.preventDefault();
                if (e.originalEvent.deltaY < 0) {
                    zoomImage(panelId, 'in');
                } else {
                    zoomImage(panelId, 'out');
                }
            });
        }

        function loadAnnotations(panelId, folderName, fileName) {
            $.get(`/api/transcription/annotations/${encodeURIComponent(folderName)}/${encodeURIComponent(fileName)}`, function(data) {
                const container = $(`#annotations-${panelId}`);
                container.empty();

                if (data.annotations && data.annotations.length > 0) {
                    data.annotations.forEach(ann => {
                        const time = new Date(ann.created_at).toLocaleString();
                        container.append(`
                            <div class="annotation-item">
                                <p class="annotation-text">${ann.annotation_text}</p>
                                <div class="annotation-time"><i class="fas fa-clock"></i> ${time}</div>
                            </div>
                        `);
                    });
                } else {
                    container.html('<p class="text-muted">No annotations yet.</p>');
                }
            }).fail(function() {
                $(`#annotations-${panelId}`).html('<p class="text-danger">Failed to load annotations.</p>');
            });
        }

        function addAnnotation(panelId) {
            const state = panelState[panelId];
            const input = $(`#new-annotation-${panelId}`);
            const annotationText = input.val().trim();

            if (!annotationText) {
                alert('Please enter an annotation.');
                return;
            }

            if (!state.folder || !state.currentFile) {
                alert('No file selected.');
                return;
            }

            $.ajax({
                url: '/api/transcription/annotations',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    folder_name: state.folder,
                    file_name: state.currentFile.name,
                    annotation_text: annotationText
                }),
                success: function() {
                    input.val('');
                    loadAnnotations(panelId, state.folder, state.currentFile.name);
                },
                error: function(error) {
                    alert('Failed to save annotation: ' + (error.responseJSON?.error || 'Unknown error'));
                }
            });
        }

        function setLayout(layout) {
            currentLayout = layout;

            $('.layout-btn').removeClass('active');
            $(`.layout-btn:contains('${layout === 'single' ? 'Single' : 'Dual'}')`).addClass('active');

            if (layout === 'single') {
                $('#panel-right').addClass('hidden');
            } else {
                $('#panel-right').removeClass('hidden');
            }
        }
    </script>
</body>
</html>
