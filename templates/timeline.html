{% extends "base.html" %}

{% block title %}Time Analysis - Plant Phenology Observation Data Visualization Platform{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>
            <i class="fas fa-chart-line text-primary"></i>
            Phenological Period Time Analysis
        </h2>
        <p class="text-muted">Analyze interannual variation trends of plant phenological periods and explore climate change impacts</p>
    </div>
</div>

<!-- Analysis Parameters Selection -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-sliders-h me-2"></i>
                    Analysis Parameter Settings
                </h5>
                <div id="station-info-badge" style="display: none;">
                    <span class="badge bg-primary">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        Station: <span id="station-name-display"></span>
                    </span>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="station-select" class="form-label">
                            Select Station (Optional)
                            <span class="badge bg-info ms-1" id="station-filter-badge" style="display: none;">Filtered</span>
                        </label>
                        <select class="form-select" id="station-select">
                            <option value="">All stations...</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="species-select" class="form-label">
                            Select Species
                            <span class="badge bg-info ms-1" id="species-filter-badge" style="display: none;">Filtered</span>
                        </label>
                        <select class="form-select" id="species-select" required>
                            <option value="">Please select species...</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="phase-select" class="form-label">
                            Select Phenological Phase
                            <span class="badge bg-info ms-1" id="phase-filter-badge" style="display: none;">Filtered</span>
                        </label>
                        <select class="form-select" id="phase-select" required>
                            <option value="">Please select phenological phase...</option>
                        </select>
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-3">
                        <label for="year-start" class="form-label">Start Year</label>
                        <input type="number" class="form-control" id="year-start" min="1953" max="2023" value="2000">
                    </div>
                    <div class="col-md-3">
                        <label for="year-end" class="form-label">End Year</label>
                        <input type="number" class="form-control" id="year-end" min="1953" max="2023" value="2023">
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100 mt-4" id="analyze-btn">
                            <i class="fas fa-play me-2"></i>Start Analysis
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary w-100 mt-4" id="clear-filters-btn">
                            <i class="fas fa-undo me-2"></i>Clear Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analysis Results -->
<div class="row mb-4" id="analysis-results" style="display: none;">
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-area me-2"></i>
                    Phenological Period Interannual Trends
                </h5>
            </div>
            <div class="card-body">
                <canvas id="trend-chart" height="400"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-4">
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Analysis Summary
                </h6>
            </div>
            <div class="card-body" id="analysis-summary">
                <!-- Analysis result summary -->
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Phenological Calendar
                </h6>
            </div>
            <div class="card-body">
                <div id="phenology-calendar">
                    <!-- Phenological calendar -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistical Analysis -->
<div class="row mb-4" id="statistics-section" style="display: none;">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Annual Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="yearly-distribution" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Observation Count Statistics
                </h5>
            </div>
            <div class="card-body">
                <canvas id="observation-stats" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Anomaly Year Detection -->
<div class="row mb-4" id="anomaly-section" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Anomaly Year Detection
                </h5>
            </div>
            <div class="card-body">
                <div id="anomaly-results">
                    <!-- Anomaly year detection results -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Data Table -->
<div class="row" id="data-table-section" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table me-2"></i>
                    Detailed Observation Data
                </h5>
                <button class="btn btn-outline-secondary btn-sm" id="export-data">
                    <i class="fas fa-download me-1"></i>Export Data
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="observation-table">
                        <thead class="table-dark">
                            <tr>
                                <th>Year</th>
                                <th>Station</th>
                                <th>Date</th>
                                <th>Day of Year</th>
                                <th>Species</th>
                                <th>Phenological Phase</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated through JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentTrendData = null;
let currentObservationData = null;
let allSpecies = []; // Store complete species list
let allPhases = []; // Store complete phases list
let allStations = []; // Store complete stations list
let currentStationId = null; // Store current station ID from URL

$(document).ready(function() {
    // Check URL parameters first
    const urlParams = new URLSearchParams(window.location.search);
    const urlStationId = urlParams.get('station');

    // Load all initial data
    loadStationsData();
    loadSpeciesData();
    loadPhasesData();

    // If URL has station parameter, preselect it
    if (urlStationId) {
        setTimeout(function() {
            $('#station-select').val(urlStationId);
            currentStationId = urlStationId;
            // Find station name and update badge
            const station = allStations.find(s => s.id == urlStationId);
            if (station) {
                $('#station-name-display').text(station.station_name);
                $('#station-info-badge').show();
            }
            $('#station-select').trigger('change');
        }, 500);
    }

    // Add change event listeners for three-way filtering
    $('#station-select').change(function() {
        const selectedStationId = $(this).val();
        currentStationId = selectedStationId || null;

        // Update station info badge
        if (selectedStationId) {
            const station = allStations.find(s => s.id == selectedStationId);
            if (station) {
                $('#station-name-display').text(station.station_name);
                $('#station-info-badge').show();
            }
        } else {
            $('#station-info-badge').hide();
        }

        const selectedSpeciesId = $('#species-select').val();
        const selectedPhaseId = $('#phase-select').val();

        if (selectedStationId) {
            // Station selected - filter species and phases
            if (selectedSpeciesId && selectedPhaseId) {
                // All three selected - filter based on all three
                applyTripleFilter(selectedStationId, selectedSpeciesId, selectedPhaseId);
            } else if (selectedSpeciesId) {
                // Station + Species selected - filter phases
                filterPhasesByStationAndSpecies(selectedStationId, selectedSpeciesId);
                filterStationsBySpecies(selectedSpeciesId, selectedPhaseId);
            } else if (selectedPhaseId) {
                // Station + Phase selected - filter species
                filterSpeciesByStationAndPhase(selectedStationId, selectedPhaseId);
                filterStationsByPhase(selectedPhaseId, selectedSpeciesId);
            } else {
                // Only station selected - filter both
                filterSpeciesByStation(selectedStationId);
                filterPhasesByStation(selectedStationId);
            }
            $('#station-filter-badge').hide();
        } else {
            // Station cleared
            $('#station-filter-badge').hide();
            if (selectedSpeciesId) {
                filterPhasesBySpecies(selectedSpeciesId);
                filterStationsBySpecies(selectedSpeciesId, selectedPhaseId);
            } else if (selectedPhaseId) {
                filterSpeciesByPhase(selectedPhaseId);
                filterStationsByPhase(selectedPhaseId, selectedSpeciesId);
            } else {
                // Everything cleared
                populateSpeciesSelect(allSpecies);
                populatePhaseSelect(allPhases);
                populateStationSelect(allStations);
                $('#species-filter-badge').hide();
                $('#phase-filter-badge').hide();
            }
        }
    });

    $('#species-select').change(function() {
        const selectedSpeciesId = $(this).val();
        const selectedStationId = $('#station-select').val();
        const selectedPhaseId = $('#phase-select').val();

        if (selectedSpeciesId) {
            if (selectedStationId && selectedPhaseId) {
                // All three selected
                applyTripleFilter(selectedStationId, selectedSpeciesId, selectedPhaseId);
            } else if (selectedStationId) {
                // Station + Species selected - filter phases
                filterPhasesByStationAndSpecies(selectedStationId, selectedSpeciesId);
                filterStationsBySpecies(selectedSpeciesId, selectedPhaseId);
            } else if (selectedPhaseId) {
                // Species + Phase selected - filter stations
                filterStationsBySpeciesAndPhase(selectedSpeciesId, selectedPhaseId);
            } else {
                // Only species selected
                filterPhasesBySpecies(selectedSpeciesId);
                filterStationsBySpecies(selectedSpeciesId, null);
            }
        } else {
            // Species cleared
            $('#species-filter-badge').hide();
            if (selectedStationId) {
                filterPhasesByStation(selectedStationId);
                filterStationsByPhase(selectedPhaseId, null);
            } else if (selectedPhaseId) {
                filterStationsByPhase(selectedPhaseId, null);
            } else {
                populatePhaseSelect(allPhases);
                populateStationSelect(allStations);
                $('#phase-filter-badge').hide();
                $('#station-filter-badge').hide();
            }
        }
    });

    $('#phase-select').change(function() {
        const selectedPhaseId = $(this).val();
        const selectedStationId = $('#station-select').val();
        const selectedSpeciesId = $('#species-select').val();

        if (selectedPhaseId) {
            if (selectedStationId && selectedSpeciesId) {
                // All three selected
                applyTripleFilter(selectedStationId, selectedSpeciesId, selectedPhaseId);
            } else if (selectedStationId) {
                // Station + Phase selected - filter species
                filterSpeciesByStationAndPhase(selectedStationId, selectedPhaseId);
                filterStationsByPhase(selectedPhaseId, selectedSpeciesId);
            } else if (selectedSpeciesId) {
                // Species + Phase selected - filter stations
                filterStationsBySpeciesAndPhase(selectedSpeciesId, selectedPhaseId);
            } else {
                // Only phase selected
                filterSpeciesByPhase(selectedPhaseId);
                filterStationsByPhase(selectedPhaseId, null);
            }
        } else {
            // Phase cleared
            $('#phase-filter-badge').hide();
            if (selectedStationId) {
                filterSpeciesByStation(selectedStationId);
                filterStationsBySpecies(selectedSpeciesId, null);
            } else if (selectedSpeciesId) {
                filterStationsBySpecies(selectedSpeciesId, null);
            } else {
                populateSpeciesSelect(allSpecies);
                populateStationSelect(allStations);
                $('#species-filter-badge').hide();
                $('#station-filter-badge').hide();
            }
        }
    });

    // Clear filters button
    $('#clear-filters-btn').click(function() {
        $('#station-select').val('');
        $('#species-select').val('');
        $('#phase-select').val('');
        currentStationId = null;
        populateStationSelect(allStations);
        populateSpeciesSelect(allSpecies);
        populatePhaseSelect(allPhases);
        $('#station-filter-badge').hide();
        $('#species-filter-badge').hide();
        $('#phase-filter-badge').hide();
        $('#station-info-badge').hide();
    });

    // Analysis button event
    $('#analyze-btn').click(performAnalysis);

    // Export data event
    $('#export-data').click(exportData);
});

function loadStationsData() {
    $.get('/api/stations')
        .done(function(stations) {
            allStations = stations;
            populateStationSelect(stations);
        })
        .fail(function() {
            alert('Failed to load stations data');
        });
}

function loadSpeciesData() {
    $.get('/api/species')
        .done(function(species) {
            allSpecies = species; // Save complete list
            populateSpeciesSelect(species);
        })
        .fail(function() {
            alert('Failed to load species data');
        });
}

function loadPhasesData() {
    $.get('/api/phases')
        .done(function(phases) {
            allPhases = phases; // Save complete list
            populatePhaseSelect(phases);
        })
        .fail(function() {
            alert('Failed to load phenological phase data');
        });
}

function populateStationSelect(stations) {
    const select = $('#station-select');
    const currentValue = select.val();
    select.find('option:not(:first)').remove();

    stations.forEach(function(station) {
        select.append(`
            <option value="${station.id}">
                ${station.station_name} (${station.state || ''})
            </option>
        `);
    });

    if (currentValue && select.find(`option[value="${currentValue}"]`).length > 0) {
        select.val(currentValue);
    }
}

function populateSpeciesSelect(species) {
    const select = $('#species-select');
    const currentValue = select.val(); // Save current selection
    select.find('option:not(:first)').remove(); // Clear all except the first option

    species.forEach(function(sp) {
        select.append(`
            <option value="${sp.id}" data-name="${sp.species_name_en}">
                ${sp.species_name_en} (${sp.species_name_de})
            </option>
        `);
    });

    // Restore selection if it still exists in the filtered list
    if (currentValue && select.find(`option[value="${currentValue}"]`).length > 0) {
        select.val(currentValue);
    }
}

function populatePhaseSelect(phases) {
    const select = $('#phase-select');
    const currentValue = select.val(); // Save current selection
    select.find('option:not(:first)').remove(); // Clear all except the first option

    phases.forEach(function(phase) {
        // Handle both phase.id and phase.phase_id (different API response formats)
        const phaseId = phase.id || phase.phase_id;
        select.append(`
            <option value="${phaseId}" data-name="${phase.phase_name_en}">
                ${phase.phase_name_en} (${phase.phase_name_de})
            </option>
        `);
    });

    // Restore selection if it still exists in the filtered list
    if (currentValue && select.find(`option[value="${currentValue}"]`).length > 0) {
        select.val(currentValue);
    }
}

function filterPhasesBySpecies(speciesId) {
    // Get available phases for selected species
    $.get(`/api/species-phases/${speciesId}`)
        .done(function(phases) {
            if (phases.length === 0) {
                // If no data, show message but keep the dropdown enabled
                $('#phase-select').html('<option value="">No phenological phases available for this species</option>');
                $('#phase-filter-badge').hide();
            } else {
                populatePhaseSelect(phases);
                $('#phase-filter-badge').show();
                console.log(`Filtered to ${phases.length} phenological phases with data`);
            }
        })
        .fail(function() {
            console.error('Failed to filter phases by species');
            populatePhaseSelect(allPhases);
            $('#phase-filter-badge').hide();
        });
}

function filterSpeciesByPhase(phaseId) {
    // Get available species for selected phase
    $.get('/api/species-by-phase', { phase_id: phaseId })
        .done(function(species) {
            if (species.length === 0) {
                // If no data, show message but keep the dropdown enabled
                $('#species-select').html('<option value="">No species available for this phenological phase</option>');
                $('#species-filter-badge').hide();
            } else {
                populateSpeciesSelect(species);
                $('#species-filter-badge').show();
                console.log(`Filtered to ${species.length} species with data`);
            }
        })
        .fail(function() {
            console.error('Failed to filter species by phase');
            populateSpeciesSelect(allSpecies);
            $('#species-filter-badge').hide();
        });
}

// New three-way filtering functions
function applyTripleFilter(stationId, speciesId, phaseId) {
    // When all three are selected, just show badges
    $('#station-filter-badge').show();
    $('#species-filter-badge').show();
    $('#phase-filter-badge').show();
}

// Station filtering functions
function filterSpeciesByStation(stationId) {
    $.get('/api/station-species', { station_id: stationId })
        .done(function(species) {
            if (species.length === 0) {
                $('#species-select').html('<option value="">No species available for this station</option>');
            } else {
                populateSpeciesSelect(species);
                $('#species-filter-badge').show();
            }
        })
        .fail(function() {
            console.error('Failed to filter species by station');
        });
}

function filterPhasesByStation(stationId) {
    $.get('/api/station-phases', { station_id: stationId })
        .done(function(phases) {
            if (phases.length === 0) {
                $('#phase-select').html('<option value="">No phases available for this station</option>');
            } else {
                populatePhaseSelect(phases);
                $('#phase-filter-badge').show();
            }
        })
        .fail(function() {
            console.error('Failed to filter phases by station');
        });
}

function filterPhasesByStationAndSpecies(stationId, speciesId) {
    $.get('/api/station-species-phases', {
        station_id: stationId,
        species_id: speciesId
    })
        .done(function(phases) {
            if (phases.length === 0) {
                $('#phase-select').html('<option value="">No phases available</option>');
            } else {
                populatePhaseSelect(phases);
                $('#phase-filter-badge').show();
            }
        })
        .fail(function() {
            console.error('Failed to filter phases');
        });
}

function filterSpeciesByStationAndPhase(stationId, phaseId) {
    $.get('/api/station-phase-species', {
        station_id: stationId,
        phase_id: phaseId
    })
        .done(function(species) {
            if (species.length === 0) {
                $('#species-select').html('<option value="">No species available</option>');
            } else {
                populateSpeciesSelect(species);
                $('#species-filter-badge').show();
            }
        })
        .fail(function() {
            console.error('Failed to filter species');
        });
}

// Species and Phase filtering stations
function filterStationsBySpecies(speciesId, phaseId) {
    const params = { species_id: speciesId };
    if (phaseId) params.phase_id = phaseId;

    $.get('/api/species-stations', params)
        .done(function(stations) {
            if (stations.length === 0) {
                $('#station-select').html('<option value="">No stations available</option>');
            } else {
                populateStationSelect(stations);
                $('#station-filter-badge').show();
            }
        })
        .fail(function() {
            console.error('Failed to filter stations by species');
        });
}

function filterStationsByPhase(phaseId, speciesId) {
    const params = { phase_id: phaseId };
    if (speciesId) params.species_id = speciesId;

    $.get('/api/phase-stations', params)
        .done(function(stations) {
            if (stations.length === 0) {
                $('#station-select').html('<option value="">No stations available</option>');
            } else {
                populateStationSelect(stations);
                $('#station-filter-badge').show();
            }
        })
        .fail(function() {
            console.error('Failed to filter stations by phase');
        });
}

function filterStationsBySpeciesAndPhase(speciesId, phaseId) {
    $.get('/api/species-phase-stations', {
        species_id: speciesId,
        phase_id: phaseId
    })
        .done(function(stations) {
            if (stations.length === 0) {
                $('#station-select').html('<option value="">No stations available</option>');
            } else {
                populateStationSelect(stations);
                $('#station-filter-badge').show();
            }
        })
        .fail(function() {
            console.error('Failed to filter stations');
        });
}

function performAnalysis() {
    const stationId = $('#station-select').val();
    const speciesId = $('#species-select').val();
    const phaseId = $('#phase-select').val();
    const yearStart = $('#year-start').val();
    const yearEnd = $('#year-end').val();

    if (!speciesId || !phaseId) {
        alert('Please select species and phenological phase');
        return;
    }

    // Show loading status
    $('#analyze-btn').html('<div class="spinner-border spinner-border-sm me-2"></div>Analyzing...');
    $('#analyze-btn').prop('disabled', true);

    // Prepare query parameters
    const queryParams = {
        species_id: speciesId,
        phase_id: phaseId,
        year_start: yearStart,
        year_end: yearEnd
    };

    // Add station_id if a station is selected
    if (stationId) {
        queryParams.station_id = stationId;
    }

    // Get trend data
    $.get('/api/trends', queryParams)
    .done(function(data) {
        currentTrendData = data;
        displayTrendAnalysis(data);
        loadObservationData(speciesId, phaseId, yearStart, yearEnd);
    })
    .fail(function() {
        alert('Analysis failed, please try again');
    })
    .always(function() {
        $('#analyze-btn').html('<i class="fas fa-play me-2"></i>Start Analysis');
        $('#analyze-btn').prop('disabled', false);
    });
}

function displayTrendAnalysis(data) {
    if (data.length === 0) {
        alert('No data found matching the criteria');
        return;
    }
    
    // Show result area
    $('#analysis-results').show();
    $('#statistics-section').show();
    $('#anomaly-section').show();
    $('#data-table-section').show();
    
    // Create trend chart
    const ctx = document.getElementById('trend-chart').getContext('2d');
    if (window.trendChart) {
        window.trendChart.destroy();
    }
    
    const years = data.map(d => d.reference_year);
    const avgDays = data.map(d => parseFloat(d.avg_day_of_year));
    
    window.trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: years,
            datasets: [{
                label: 'Average Day of Year',
                data: avgDays,
                borderColor: '#2c5234',
                backgroundColor: 'rgba(44, 82, 52, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const dayOfYear = context.parsed.y;
                            const date = dayOfYearToDate(2020, Math.round(dayOfYear)); // Use 2020 as reference
                            return `Approximately ${date}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    title: {
                        display: true,
                        text: 'Day of Year (days)'
                    },
                    ticks: {
                        callback: function(value) {
                            const date = dayOfYearToDate(2020, Math.round(value));
                            return `${Math.round(value)} (${date})`;
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Year'
                    }
                }
            }
        }
    });
    
    // Generate analysis summary
    generateAnalysisSummary(data);
    
    // Create annual distribution chart
    createYearlyDistribution(data);
    
    // Detect anomaly years
    detectAnomalies(data);
}

function generateAnalysisSummary(data) {
    const avgDays = data.map(d => parseFloat(d.avg_day_of_year));
    const years = data.map(d => parseInt(d.reference_year));
    const totalObs = data.reduce((sum, d) => sum + parseInt(d.observation_count), 0);
    
    const minDay = Math.min(...avgDays);
    const maxDay = Math.max(...avgDays);
    const avgDay = avgDays.reduce((sum, day) => sum + day, 0) / avgDays.length;
    
    const minYear = years[avgDays.indexOf(minDay)];
    const maxYear = years[avgDays.indexOf(maxDay)];
    
    // Calculate trend (simple linear regression)
    const trend = calculateTrend(years, avgDays);
    const trendDirection = trend > 0 ? 'Delayed' : 'Advanced';
    const trendMagnitude = Math.abs(trend * 10).toFixed(1); // Change per 10 years
    
    $('#analysis-summary').html(`
        <div class="mb-3">
            <h6 class="text-primary">Data Overview</h6>
            <ul class="list-unstyled">
                <li><strong>Observation Records:</strong> ${totalObs.toLocaleString()}</li>
                <li><strong>Year Range:</strong> ${Math.min(...years)} - ${Math.max(...years)}</li>
                <li><strong>Average Phenological Period:</strong> Day ${Math.round(avgDay)}</li>
            </ul>
        </div>
        
        <div class="mb-3">
            <h6 class="text-success">Extreme Value Analysis</h6>
            <ul class="list-unstyled">
                <li><strong>Earliest Year:</strong> ${minYear} (Day ${Math.round(minDay)})</li>
                <li><strong>Latest Year:</strong> ${maxYear} (Day ${Math.round(maxDay)})</li>
                <li><strong>Time Span:</strong> ${Math.round(maxDay - minDay)} days</li>
            </ul>
        </div>
        
        <div class="mb-3">
            <h6 class="text-warning">Trend Analysis</h6>
            <p class="mb-1">
                <span class="badge ${trend > 0 ? 'bg-danger' : 'bg-success'}">
                    ${trendDirection} Trend
                </span>
            </p>
            <p class="small text-muted mb-0">
                ${trendDirection} approximately ${trendMagnitude} days per 10 years
            </p>
        </div>
    `);
}

function createYearlyDistribution(data) {
    const ctx = document.getElementById('yearly-distribution').getContext('2d');
    if (window.yearlyChart) {
        window.yearlyChart.destroy();
    }
    
    const observationCounts = data.map(d => parseInt(d.observation_count));
    const years = data.map(d => d.reference_year);
    
    window.yearlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: years,
            datasets: [{
                label: 'Observation Count',
                data: observationCounts,
                backgroundColor: '#52b788',
                borderColor: '#2c5234',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Observation Count'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Year'
                    }
                }
            }
        }
    });
    
    // Create observation statistics pie chart
    const obsCtx = document.getElementById('observation-stats').getContext('2d');
    if (window.obsChart) {
        window.obsChart.destroy();
    }
    
    const totalObs = observationCounts.reduce((sum, count) => sum + count, 0);
    const recentObs = observationCounts.slice(-10).reduce((sum, count) => sum + count, 0);
    const earlyObs = totalObs - recentObs;
    
    window.obsChart = new Chart(obsCtx, {
        type: 'doughnut',
        data: {
            labels: ['Last 10 Years', 'Earlier Data'],
            datasets: [{
                data: [recentObs, earlyObs],
                backgroundColor: ['#2c5234', '#95d5b2']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function detectAnomalies(data) {
    const avgDays = data.map(d => parseFloat(d.avg_day_of_year));
    const years = data.map(d => d.reference_year);
    
    // Calculate standard deviation
    const mean = avgDays.reduce((sum, day) => sum + day, 0) / avgDays.length;
    const variance = avgDays.reduce((sum, day) => sum + Math.pow(day - mean, 2), 0) / avgDays.length;
    const stdDev = Math.sqrt(variance);
    
    // Find outliers (exceeding 2 standard deviations)
    const anomalies = [];
    avgDays.forEach((day, index) => {
        const zScore = Math.abs((day - mean) / stdDev);
        if (zScore > 2) {
            anomalies.push({
                year: years[index],
                day: day,
                deviation: day - mean,
                zScore: zScore
            });
        }
    });
    
    if (anomalies.length > 0) {
        let anomalyHtml = '<div class="row g-3">';
        anomalies.forEach(anomaly => {
            const isEarly = anomaly.deviation < 0;
            anomalyHtml += `
                <div class="col-md-6">
                    <div class="alert ${isEarly ? 'alert-info' : 'alert-warning'} mb-0">
                        <h6 class="alert-heading">
                            <i class="fas fa-${isEarly ? 'arrow-down' : 'arrow-up'} me-1"></i>
                            Year ${anomaly.year}
                        </h6>
                        <p class="mb-1">
                            <strong>Phenological Period:</strong> Day ${Math.round(anomaly.day)}
                        </p>
                        <p class="mb-0">
                            <strong>Deviation:</strong> ${isEarly ? 'Advanced' : 'Delayed'} ${Math.abs(anomaly.deviation).toFixed(1)} days
                        </p>
                    </div>
                </div>
            `;
        });
        anomalyHtml += '</div>';
        $('#anomaly-results').html(anomalyHtml);
    } else {
        $('#anomaly-results').html(`
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                No significant anomaly years detected
            </div>
        `);
    }
}

function loadObservationData(speciesId, phaseId, yearStart, yearEnd) {
    const stationId = $('#station-select').val();
    const queryParams = {
        species_id: speciesId,
        phase_id: phaseId,
        year_start: yearStart,
        year_end: yearEnd,
        limit: 500
    };

    // Add station_id if a station is selected
    if (stationId) {
        queryParams.station_id = stationId;
    }

    $.get('/api/observations', queryParams)
    .done(function(data) {
        currentObservationData = data;
        updateObservationTable(data);
    })
    .fail(function() {
        console.error('Failed to load detailed observation data');
    });
}

function updateObservationTable(data) {
    const tbody = $('#observation-table tbody');
    tbody.empty();
    
    if (data.length === 0) {
        tbody.append('<tr><td colspan="6" class="text-center text-muted">No detailed observation data available</td></tr>');
        return;
    }
    
    data.forEach(obs => {
        tbody.append(`
            <tr>
                <td>${obs.reference_year}</td>
                <td>${obs.station_name}</td>
                <td>${obs.date ? new Date(obs.date).toLocaleDateString() : 'Unknown'}</td>
                <td>${obs.day_of_year}</td>
                <td>${obs.species_name_en}</td>
                <td>${obs.phase_name_en}</td>
            </tr>
        `);
    });
    
    if (data.length >= 500) {
        tbody.append(`
            <tr>
                <td colspan="6" class="text-center text-muted">
                    Showing first 500 records...
                </td>
            </tr>
        `);
    }
}

function exportData() {
    if (!currentObservationData) {
        alert('No data available for export');
        return;
    }
    
    // Convert to CSV format
    const headers = ['Year', 'Station', 'Date', 'Day of Year', 'Species', 'Phenological Phase'];
    const csvContent = [
        headers.join(','),
        ...currentObservationData.map(obs => [
            obs.reference_year,
            `"${obs.station_name}"`,
            obs.date ? new Date(obs.date).toLocaleDateString() : '',
            obs.day_of_year,
            `"${obs.species_name_en}"`,
            `"${obs.phase_name_en}"`
        ].join(','))
    ].join('\n');
    
    // Create download link
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `phenology_data_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
}

// Utility functions
function dayOfYearToDate(year, dayOfYear) {
    const date = new Date(year, 0, dayOfYear);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function calculateTrend(years, values) {
    const n = years.length;
    const sumX = years.reduce((sum, year) => sum + year, 0);
    const sumY = values.reduce((sum, value) => sum + value, 0);
    const sumXY = years.reduce((sum, year, i) => sum + year * values[i], 0);
    const sumXX = years.reduce((sum, year) => sum + year * year, 0);
    
    return (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
}
</script>
{% endblock %}