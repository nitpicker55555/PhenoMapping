{% extends "base.html" %}

{% block title %}Geography - Plant Phenology Observation Data Visualization Platform{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>
            <i class="fas fa-map text-primary"></i>
            Observation Station Geographic Distribution
        </h2>
        <p class="text-muted">Explore the spatial distribution and observation data of 1000+ stations across Germany</p>
    </div>
</div>

<!-- Filter Controls -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="state-filter" class="form-label">Select State</label>
                        <select class="form-select" id="state-filter">
                            <option value="">All States</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="altitude-filter" class="form-label">Altitude Range</label>
                        <select class="form-select" id="altitude-filter">
                            <option value="">All Altitudes</option>
                            <option value="0-100">0-100m</option>
                            <option value="100-300">100-300m</option>
                            <option value="300-500">300-500m</option>
                            <option value="500+">Above 500m</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="observation-filter" class="form-label">Observation Count</label>
                        <select class="form-select" id="observation-filter">
                            <option value="">All Stations</option>
                            <option value="high">High Frequency (>10000)</option>
                            <option value="medium">Medium Frequency (1000-10000)</option>
                            <option value="low">Low Frequency (<1000)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100 mt-4" id="apply-filters">
                            <i class="fas fa-filter me-2"></i>Apply Filters
                        </button>
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <button class="btn btn-info w-100" id="show-new-data-locations">
                            <i class="fas fa-database me-2"></i>Show Pheno Archive Locations
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-secondary w-100" id="reset-view">
                            <i class="fas fa-undo me-2"></i>Reset View
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Map and Statistics -->
<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-globe me-2"></i>
                    Interactive Map
                </h5>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="map-type" id="terrain" checked>
                    <label class="btn btn-outline-secondary btn-sm" for="terrain">Terrain</label>
                    
                    <input type="radio" class="btn-check" name="map-type" id="satellite">
                    <label class="btn btn-outline-secondary btn-sm" for="satellite">Satellite</label>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="main-map" style="height: 600px;"></div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-4">
        <!-- Station信息 -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Station Details
                </h6>
            </div>
            <div class="card-body" id="station-info">
                <p class="text-muted text-center">Click on a station on the map to view details</p>
            </div>
        </div>
        
        <!-- 地区统计 -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Regional Distribution Statistics
                </h6>
            </div>
            <div class="card-body">
                <canvas id="region-chart" height="300"></canvas>
            </div>
        </div>
        
        <!-- 海拔分布 -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-mountain me-2"></i>
                    Altitude Distribution
                </h6>
            </div>
            <div class="card-body">
                <canvas id="altitude-chart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Data Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table me-2"></i>
                    Station Details List
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
                    <table class="table table-striped table-hover" id="stations-table">
                        <thead class="table-dark">
                            <tr>
                                <th>Station Name</th>
                                <th>State</th>
                                <th>Latitude</th>
                                <th>Longitude</th>
                                <th>Altitude(m)</th>
                                <th>Observation Count</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
.custom-div-icon {
    background-color: transparent !important;
    border: none !important;
}
</style>
<script>
const EXCLUDED_STATIONS = ['Unknown', 'Unknown_49-51', 'Bemerkungen', 'Spitzel', 'Schramm', 'Airischwand'];

let mainMap;
let allStations = [];
let currentStations = [];
let stationMarkers = L.layerGroup();
let newDataMarkers = L.layerGroup();
let showingNewData = false;

$(document).ready(function() {
    initMainMap();
    loadStationsData();
    
    // Filter button event
    $('#apply-filters').click(applyFilters);
    
    // New data locations button
    $('#show-new-data-locations').click(function() {
        if (!showingNewData) {
            loadNewDataLocations();
        } else {
            hideNewDataLocations();
        }
    });
    
    // Reset view button
    $('#reset-view').click(function() {
        resetMapView();
    });
});

function initMainMap() {
    // Create main map
    mainMap = L.map('main-map').setView([51.1657, 10.4515], 6);
    
    // Default terrain layer
    const terrainLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    });
    
    // Satellite layer
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '© Esri'
    });
    
    terrainLayer.addTo(mainMap);
    
    // Layer switching
    $('input[name="map-type"]').change(function() {
        if ($(this).attr('id') === 'terrain') {
            mainMap.removeLayer(satelliteLayer);
            terrainLayer.addTo(mainMap);
        } else {
            mainMap.removeLayer(terrainLayer);
            satelliteLayer.addTo(mainMap);
        }
    });
    
    // Add marker layer groups
    stationMarkers.addTo(mainMap);
    newDataMarkers.addTo(mainMap);
}

function loadStationsData() {
    $.get('/api/stations')
        .done(function(stations) {
            stations = stations.filter(s => !EXCLUDED_STATIONS.includes(s.station_name));
            allStations = stations;
            currentStations = stations;
            
            // Populate state filter
            const states = [...new Set(stations.map(s => s.state).filter(s => s))];
            states.sort();
            states.forEach(state => {
                $('#state-filter').append(`<option value="${state}">${state}</option>`);
            });
            
            // Display stations
            displayStations(stations);
            // Update statistical charts
            updateCharts(stations);
            // Update data table
            updateTable(stations);
        })
        .fail(function() {
            alert('Failed to load station data');
        });
}

function displayStations(stations) {
    // Clear existing markers
    stationMarkers.clearLayers();
    
    stations.forEach(function(station) {
        if (station.latitude && station.longitude) {
            // Determine marker size and color based on observation count
            let color, radius;
            const count = parseInt(station.observation_count) || 0;
            
            if (count > 10000) {
                color = '#2c5234';
                radius = 8;
            } else if (count > 1000) {
                color = '#52b788';
                radius = 6;
            } else {
                color = '#95d5b2';
                radius = 4;
            }
            
            const marker = L.circleMarker([
                parseFloat(station.latitude),
                parseFloat(station.longitude)
            ], {
                color: color,
                fillColor: color,
                fillOpacity: 0.4,
                weight: 0,
                opacity: 0,
                radius: radius
            });
            
            marker.bindPopup(`
                <div class="popup-content">
                    <h6 class="mb-2">${station.station_name}</h6>
                    <p class="mb-1"><strong>State:</strong> ${station.state || 'Unknown'}</p>
                    <p class="mb-1"><strong>Altitude:</strong> ${station.altitude}m</p>
                    <p class="mb-1"><strong>Observations:</strong> ${count.toLocaleString()}</p>
                    <p class="mb-0"><strong>Region:</strong> ${station.area_group || 'Unknown'}</p>
                </div>
            `);
            
            marker.on('click', function() {
                showStationDetail(station);
            });
            
            stationMarkers.addLayer(marker);
        }
    });
}

function showStationDetail(station) {
    const count = parseInt(station.observation_count) || 0;
    
    $('#station-info').html(`
        <h6 class="text-primary">${station.station_name}</h6>
        <hr>
        <div class="row g-2">
            <div class="col-6">
                <small class="text-muted">State</small>
                <div class="fw-bold">${station.state || 'Unknown'}</div>
            </div>
            <div class="col-6">
                <small class="text-muted">Altitude</small>
                <div class="fw-bold">${station.altitude}m</div>
            </div>
            <div class="col-6">
                <small class="text-muted">Latitude</small>
                <div class="fw-bold">${parseFloat(station.latitude).toFixed(4)}</div>
            </div>
            <div class="col-6">
                <small class="text-muted">Longitude</small>
                <div class="fw-bold">${parseFloat(station.longitude).toFixed(4)}</div>
            </div>
            <div class="col-12">
                <small class="text-muted">Observation Count</small>
                <div class="fw-bold text-success">${count.toLocaleString()}</div>
            </div>
            <div class="col-12">
                <small class="text-muted">Area Group</small>
                <div class="fw-bold">${station.area_group || 'Unknown'}</div>
            </div>
        </div>
        <hr>
        <div class="d-grid gap-2">
            <button class="btn btn-outline-primary btn-sm" onclick="viewStationData('${station.id}')">
                <i class="fas fa-chart-line me-1"></i>View Observation Data
            </button>
        </div>
    `);
}

function viewStationData(stationId) {
    // Navigate to timeline page with station ID parameter
    window.location.href = `/timeline?station=${stationId}`;
}

function applyFilters() {
    let filtered = [...allStations];
    
    // 州筛选
    const stateFilter = $('#state-filter').val();
    if (stateFilter) {
        filtered = filtered.filter(s => s.state === stateFilter);
    }
    
    // 海拔筛选
    const altitudeFilter = $('#altitude-filter').val();
    if (altitudeFilter) {
        filtered = filtered.filter(s => {
            const alt = parseInt(s.altitude) || 0;
            switch(altitudeFilter) {
                case '0-100': return alt <= 100;
                case '100-300': return alt > 100 && alt <= 300;
                case '300-500': return alt > 300 && alt <= 500;
                case '500+': return alt > 500;
                default: return true;
            }
        });
    }
    
    // 观测数量筛选
    const obsFilter = $('#observation-filter').val();
    if (obsFilter) {
        filtered = filtered.filter(s => {
            const count = parseInt(s.observation_count) || 0;
            switch(obsFilter) {
                case 'high': return count > 10000;
                case 'medium': return count >= 1000 && count <= 10000;
                case 'low': return count < 1000;
                default: return true;
            }
        });
    }
    
    currentStations = filtered;
    displayStations(filtered);
    updateCharts(filtered);
    updateTable(filtered);
}

function updateCharts(stations) {
    // Regional distribution statistics
    const stateCount = {};
    stations.forEach(s => {
        const state = s.state || 'Unknown';
        stateCount[state] = (stateCount[state] || 0) + 1;
    });
    
    // Create or update regional distribution chart
    const regionCtx = document.getElementById('region-chart').getContext('2d');
    if (window.regionChart) {
        window.regionChart.destroy();
    }
    
    window.regionChart = new Chart(regionCtx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(stateCount),
            datasets: [{
                data: Object.values(stateCount),
                backgroundColor: [
                    '#2c5234', '#52b788', '#95d5b2', '#b7e4c7', 
                    '#d8f3dc', '#74c69d', '#40916c', '#081c15'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12,
                        font: {
                            size: 10
                        }
                    }
                }
            }
        }
    });
    
    // Altitude distribution histogram
    const altitudes = stations.map(s => parseInt(s.altitude) || 0);
    const altitudeBins = [0, 100, 300, 500, 1000, 2000];
    const altitudeCounts = new Array(altitudeBins.length - 1).fill(0);
    
    altitudes.forEach(alt => {
        for (let i = 0; i < altitudeBins.length - 1; i++) {
            if (alt >= altitudeBins[i] && alt < altitudeBins[i + 1]) {
                altitudeCounts[i]++;
                break;
            }
        }
    });
    
    const altitudeCtx = document.getElementById('altitude-chart').getContext('2d');
    if (window.altitudeChart) {
        window.altitudeChart.destroy();
    }
    
    window.altitudeChart = new Chart(altitudeCtx, {
        type: 'bar',
        data: {
            labels: ['0-100m', '100-300m', '300-500m', '500-1000m', '1000m+'],
            datasets: [{
                label: 'Station Count',
                data: altitudeCounts,
                backgroundColor: '#52b788',
                borderColor: '#2c5234',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function updateTable(stations) {
    const tbody = $('#stations-table tbody');
    tbody.empty();
    
    if (stations.length === 0) {
        tbody.append('<tr><td colspan="7" class="text-center text-muted">No stations found matching the criteria</td></tr>');
        return;
    }
    
    // Show first 100 stations（Performance consideration）
    const displayStations = stations.slice(0, 100);
    
    displayStations.forEach(station => {
        const count = parseInt(station.observation_count) || 0;
        tbody.append(`
            <tr>
                <td>${station.station_name}</td>
                <td>${station.state || 'Unknown'}</td>
                <td>${parseFloat(station.latitude).toFixed(4)}</td>
                <td>${parseFloat(station.longitude).toFixed(4)}</td>
                <td>${station.altitude}</td>
                <td>${count.toLocaleString()}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="centerMapOnStation(${station.latitude}, ${station.longitude})">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="viewStationData('${station.id}')">
                        <i class="fas fa-chart-line"></i>
                    </button>
                </td>
            </tr>
        `);
    });
    
    if (stations.length > 100) {
        tbody.append(`
            <tr>
                <td colspan="7" class="text-center text-muted">
                    Showing first 100 stations out of ${stations.length} total
                </td>
            </tr>
        `);
    }
}

function centerMapOnStation(lat, lng) {
    mainMap.setView([lat, lng], 12);
}

// Pheno Archive Location functions
function loadNewDataLocations() {
    $('#show-new-data-locations').html('<i class="fas fa-spinner fa-spin me-2"></i>Loading...');

    $.get('/api/stations', { data_source: 'pheno_new' })
        .done(function(stations) {
            // Filter excluded and those without coordinates
            stations = stations.filter(s => !EXCLUDED_STATIONS.includes(s.station_name) && s.latitude && s.longitude);
            // Convert to location format for displayNewDataLocations
            const locations = stations.map(s => ({
                name: s.station_name,
                latitude: parseFloat(s.latitude),
                longitude: parseFloat(s.longitude),
                observations: s.observation_count || 0
            }));
            displayNewDataLocations(locations);
            showingNewData = true;
            $('#show-new-data-locations').html('<i class="fas fa-eye-slash me-2"></i>Hide Pheno Archive Locations');

            // Update station info panel
            $('#station-info').html(`
                <div class="alert alert-info mb-0">
                    <h6 class="alert-heading">Pheno Archive Locations</h6>
                    <p class="mb-2">Showing ${locations.length} locations from Pheno Archive (1856)</p>
                    <ul class="mb-0" style="max-height: 300px; overflow-y: auto;">
                        ${locations.map(loc => `<li>${loc.name} (${loc.observations} observations)</li>`).join('')}
                    </ul>
                </div>
            `);
        })
        .fail(function() {
            alert('Failed to load Pheno Archive locations');
            $('#show-new-data-locations').html('<i class="fas fa-database me-2"></i>Show Pheno Archive Locations');
        });
}

function displayNewDataLocations(locations) {
    // Clear existing new data markers
    newDataMarkers.clearLayers();

    // Filter out excluded stations
    locations = locations.filter(loc => !EXCLUDED_STATIONS.includes(loc.name));

    // Create bounds to fit all locations
    const bounds = L.latLngBounds();

    locations.forEach(function(location) {
        if (location.latitude && location.longitude) {
            const radius = 3 + Math.min(12, Math.log10((location.observations || 1) + 1) * 4);
            const marker = L.circleMarker([location.latitude, location.longitude], {
                fillColor: '#e74c3c',
                fillOpacity: 0.8,
                weight: 0,
                radius: radius
            });

            marker.bindPopup(`
                <div class="popup-content">
                    <h6 class="mb-2 text-info">Pheno Archive Location</h6>
                    <p class="mb-1"><strong>Name:</strong> ${location.name}</p>
                    <p class="mb-1"><strong>Coordinates:</strong> ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}</p>
                    <p class="mb-1"><strong>Observations:</strong> ${location.observations}</p>
                    <p class="mb-0"><strong>Source:</strong> Pheno Archive (1856)</p>
                </div>
            `);

            marker.on('click', function() {
                showNewDataStationDetail(location);
            });

            newDataMarkers.addLayer(marker);
            bounds.extend([location.latitude, location.longitude]);
        }
    });

    // Fit map to show all new data locations
    if (locations.some(loc => loc.latitude && loc.longitude)) {
        mainMap.fitBounds(bounds, { padding: [50, 50] });
    }
}

function showNewDataStationDetail(location) {
    $('#station-info').html(`
        <h6 class="text-info">${location.name}</h6>
        <hr>
        <div class="row g-2">
            <div class="col-6">
                <small class="text-muted">Latitude</small>
                <div class="fw-bold">${location.latitude.toFixed(4)}</div>
            </div>
            <div class="col-6">
                <small class="text-muted">Longitude</small>
                <div class="fw-bold">${location.longitude.toFixed(4)}</div>
            </div>
            <div class="col-12">
                <small class="text-muted">Observations</small>
                <div class="fw-bold text-info">${(location.observations || 0).toLocaleString()}</div>
            </div>
            <div class="col-12">
                <small class="text-muted">Source</small>
                <div class="fw-bold">Pheno Archive</div>
            </div>
        </div>
    `);
}

function hideNewDataLocations() {
    newDataMarkers.clearLayers();
    showingNewData = false;
    $('#show-new-data-locations').html('<i class="fas fa-database me-2"></i>Show Pheno Archive Locations');
    
    // Reset station info
    $('#station-info').html('<p class="text-muted text-center">Click on a station on the map to view details</p>');
}

function resetMapView() {
    // Reset to default Germany view
    mainMap.setView([51.1657, 10.4515], 6);
    
    // Clear filters
    $('#state-filter').val('');
    $('#altitude-filter').val('');
    $('#observation-filter').val('');
    
    // Reset to all stations
    currentStations = allStations;
    displayStations(allStations);
    updateCharts(allStations);
    updateTable(allStations);
    
    // Hide new data if showing
    if (showingNewData) {
        hideNewDataLocations();
    }
}
</script>
{% endblock %}